<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <link rel="stylesheet" href="css/latex.css">
  <link rel="stylesheet" href="css/prism.css">
  <link rel="stylesheet" href="css/index.css">
</head>
<body class="latex-dark">
  <main>
    <article>
    <h1>SQL</h1>
    <p>Structured Query Language</p>
    <p>Linguaggio dichiarativo.</p>
    <p>DDL: comandi per creare strutture per l’ossatura della base di
    dati (<code>CREATE TABLE</code>, <code>CREATE VIEW</code>, …)<br />
    DML: istruzioni (<code>INSERT</code>, <code>DELETE</code>,
    <code>UPDATE</code>, …)<br /> DQL: <code>SELECT</code><br /> DCL:
    comandi sul controllo</p>
    <h2 id="funzioni-operatori-clausole"><a
    href="#funzioni-operatori-clausole">Funzioni / operatori /
    clausole</a></h2>
    <ul>
    <li><code>lower</code> trasforma la stringa in lowercase</li>
    <li><code>like</code></li>
    <li><code>ilike</code> insensitive <code>like</code></li>
    <li><code>trim</code> rimuove gli spazi prima e dopo</li>
    <li><code>ltrim</code> spazi a sinistra</li>
    <li><code>rtrim</code> spazi a destra</li>
    <li><code>between</code> ad esempio
    <code>... vote BETWEEN 1 and 10;</code></li>
    <li><code>in</code> ad esempio
    <code>... lower(genre) in ('drama', 'thriller', 'crime')</code></li>
    <li><code>distinct</code>
    <ul>
    <li>ad esempio <code>SELECT DISTINCT movie FROM imdb.genre</code>
    (elimina i duplicati, rendendo il risultato “come fosse in algebra
    relazionale”)</li>
    <li><code>SELECT DISTINCT movie, genre FROM imdb.genre</code> perché
    <code>DISTINCT</code> lavora sull’intera clausola
    <code>SELECT</code></li>
    </ul></li>
    <li><code>order by</code> ordina ciò che restituiamo, e’ l’ultima
    cosa che viene fatta; si può specificare <code>DESC</code> per più
    attributi in base alle necessita’ Si puo’ fare
    <code>ORDER BY 2</code> per riferirsi alla colonna
    <code>2</code></li>
    <li><code>extract</code> permette di prendere parti di una data come
    ad esempio
    <code>WHERE extract(YEAR FROM birth_date) = '1971'</code></li>
    <li><code>as</code> e’ l’equivalente di <span
    class="math inline"><em>ρ</em></span> nell’algebra relazionale</li>
    <li><code>::</code> e’ l’operatore di cast
    <code>SELECT extract(year) from birth_date)::char(4) from imdb.person</code></li>
    <li><code>is null</code> unico modo per confrontare con
    <code>NULL</code><br />
    </li>
    <li><code>ALL</code> da true solo se il predicato e’ verificato per
    tutti i valori restituiti dalla sotto query ad esempio nella
    seguente ammettendo che la sub-query ritornasse più valori, allora
    un record per poter essere restituito dovrebbe essere maggiore di
    tutti questi valori</li>
    </ul>
    <div class="sourceCode" id="cb1"><pre
    class="sourceCode sql"><code class="sourceCode sql"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>, official_title, <span class="fu">length</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> imdb.movie</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> <span class="fu">length</span> <span class="op">&gt;</span> <span class="kw">ALL</span> (</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> <span class="fu">length</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> imdb.movie</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">WHERE</span> official_title <span class="op">=</span> <span class="st">&#39;Inception&#39;</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>);</span></code></pre></div>
    <ul>
    <li><code>ANY</code> da true se il predicato e’ verificato per
    almeno un valore restituito dalla sotto query</li>
    <li><code>min/max</code> (agg)</li>
    <li><code>avg</code> (agg)</li>
    <li><code>sum</code> (agg)</li>
    <li><code>count</code> (agg) cardinalità di una relazione
    <ul>
    <li><code>COUNT(*)</code> conta tutte le righe</li>
    <li><code>COUNT(attributo)</code> conta le occorrenze in cui
    l’attributo non e’ <code>NULL</code>, sempre bene contare su chiave
    esterna per essere sicuro che sia <code>NOT NULL</code></li>
    </ul></li>
    <li><code>group by</code> (agg) partizionare i record in base ad un
    criterio</li>
    <li><code>having</code> filtra sul risultato del gruppo, quindi su
    operatori aggregati o sugli attributi del gruppo; come
    ottimizzazione e’ meglio usare una <code>WHERE</code> prima di
    arrivare alla <code>GROUP BY</code> in modo da raggruppare su meno
    record, quindi e’ sconsigliato usare la <code>HAVING</code> al suo
    posto</li>
    </ul>
    <p>(agg) sono operatori di aggregamento, ignorano il
    <code>NULL</code>; vengono eseguiti alla fine; posso proiettare solo
    attributi aggregati o prodotti da un operatore di aggregamento. Non
    si possono fare aggregati di aggregati.</p>
    <p>La precedenza degli operatori logici viene valutata da sinistra
    verso destra, quindi</p>
    <div class="sourceCode" id="cb2"><pre
    class="sourceCode sql"><code class="sourceCode sql"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> imdb.movie</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> <span class="dt">year</span> <span class="st">&#39;2010&#39;</span> <span class="kw">OR</span> <span class="fu">length</span> <span class="op">&gt;=</span> <span class="dv">60</span> <span class="kw">AND</span> <span class="fu">length</span> <span class="op">&lt;=</span> <span class="dv">120</span>;</span></code></pre></div>
    <p>Prima valuta <code>year '2010' OR length &gt;= 60</code> e poi il
    risultato di questa in <code>AND</code>.</p>
    <p><code>%</code> segnaposto per una stringa di qualsiasi lunghezza
    <code>_</code> segnaposto per una stringa di lunghezza 1</p>
    <h2 id="prodotto-cartesiano"><a href="#prodotto-cartesiano">Prodotto
    cartesiano</a></h2>
    <div class="sourceCode" id="cb3"><pre
    class="sourceCode sql"><code class="sourceCode sql"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> imdb.movie, imdb.produced</span></code></pre></div>
    <p>Cardinalità totale e’ uguale a cardinalità movie (1033) per
    cardinalità produced (1332).</p>
    <h2 id="join"><a href="#join">Join</a></h2>
    <p>Sono una selezione sul prodotto cartesiano.</p>
    <div class="sourceCode" id="cb4"><pre
    class="sourceCode sql"><code class="sourceCode sql"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> imdb.movie m, imdb.produced p</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> m.<span class="kw">id</span> <span class="op">=</span> p.movie</span></code></pre></div>
    <p><code>movie.id</code> chiave primaria,
    <code>produced.movie</code> chiave esterna. Cardinalità e’ uguale a
    cardinalità di produced.</p>
    <p>Sintassi alternativa</p>
    <div class="sourceCode" id="cb5"><pre
    class="sourceCode sql"><code class="sourceCode sql"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> m.<span class="kw">id</span>, m.official_title</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> imdb.movie m </span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="kw">INNER</span> <span class="kw">join</span> imdb.produced p <span class="kw">ON</span> m.<span class="kw">id</span> <span class="op">=</span> p.movie</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> country <span class="op">=</span> <span class="st">&#39;USA&#39;</span></span></code></pre></div>
    <p><code>a JOIN b ON c</code> restituisce i record di <code>a</code>
    e <code>b</code> nel prodotto cartesiano che soddisfano
    <code>c</code>.</p>
    <p>Eventuali <code>WHERE</code> vengono applicate dopo la
    <code>JOIN</code>!</p>
    <h2 id="join-esterno-outer-join"><a
    href="#join-esterno-outer-join">Join esterno (outer join)</a></h2>
    <p>Aggiunge al join eventuali record che non hanno alcuna
    corrispondenza nella tabella di destra (nel caso di
    <code>LEFT JOIN</code>). Prima fa un <code>INNER JOIN</code>
    applicando le clausole <code>ON</code>, poi aggiunge i record spuri
    (che sono quelli della tabella “dall’altro lato” per cui non e’
    stato trovato un corrispondente).</p>
    <p>Ad esempio per la richiesta “selezionare paesi nei quali non sono
    prodotti film”:</p>
    <div class="sourceCode" id="cb6"><pre
    class="sourceCode sql"><code class="sourceCode sql"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> c.iso3</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> country c</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="kw">LEFT</span> <span class="kw">JOIN</span> produced p <span class="kw">ON</span> c.iso3 <span class="op">=</span> p.country</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> p.country <span class="kw">IS</span> <span class="kw">null</span></span></code></pre></div>
    <p>La cardinalità quindi include anche i record senza
    corrispondenza.</p>
    <p><code>FULL JOIN</code> combina <code>LEFT</code> e
    <code>RIGHT</code>.</p>
    <h2 id="viste"><a href="#viste">Viste</a></h2>
    <p>Oggetti derivati formati a partire dai dati nelle tabelle, per
    offrire delle proiezioni dei dati tipicamente appartenenti a tabelle
    diverse.</p>
    <div class="sourceCode" id="cb7"><pre
    class="sourceCode sql"><code class="sourceCode sql"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">VIEW</span> movie_person <span class="kw">as</span> (</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> <span class="op">*</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> movie </span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">INNER</span> <span class="kw">JOIN</span> crew <span class="kw">on</span> movie.<span class="kw">id</span> crew.movie</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">INNER</span> <span class="kw">JOIN</span> person <span class="kw">on</span> person.<span class="kw">id</span> <span class="op">=</span> crew.person</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
    <p>A questo punto trovare le persone di inception diventa quanto
    segue. Prima viene eseguita <code>movie_person</code> e poi viene
    eseguita la seconda query (nessuna duplicazione dei dati).</p>
    <div class="sourceCode" id="cb8"><pre
    class="sourceCode sql"><code class="sourceCode sql"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> movie_person</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> official_title ilike <span class="st">&#39;inception&#39;</span> <span class="kw">AND</span> p_role <span class="st">&#39;actor&#39;</span></span></code></pre></div>
    <h2 id="explain"><a href="#explain">Explain</a></h2>
    <p>Controllare i costi di una query, mostra l’albero di esecuzione
    della query. Si parte a leggere dalle foglie.</p>
    <div class="sourceCode" id="cb9"><pre
    class="sourceCode sql"><code class="sourceCode sql"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">EXPLAIN</span> <span class="kw">ANALYZE</span> <span class="op">..</span>.</span></code></pre></div>
    <h2 id="query-correlata"><a href="#query-correlata">Query
    correlata</a></h2>
    <p>Molto inefficiente TODO espandere</p>
    <h2 id="query-ricorsive"><a href="#query-ricorsive">Query
    ricorsive</a></h2>
    <p>La tabella <code>sim</code> descrive similarità tra pellicole, la
    colonna <code>cause</code> spiega il motivo di questa
    similarità.</p>
    <ul>
    <li>Data una pellicola specifica suggerire le pellicole simili</li>
    </ul>
    <p>Sono interessato alla pellicola <code>0013444</code>, le sono
    simili quelle che rispondono a</p>
    <div class="sourceCode" id="cb10"><pre
    class="sourceCode sql"><code class="sourceCode sql"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> movie2 <span class="kw">FROM</span> sim <span class="kw">WHERE</span> movie1 <span class="op">=</span> <span class="st">&#39;0013444&#39;</span></span></code></pre></div>
    <p>Ma sono simili a <code>0013444</code> anche le pellicole simili a
    quelle restituite dalla query precedente, cioè se
    <code>0018756</code> e’ restituito dalla query precedente, anche le
    query simili a <code>0018756</code> sono indirettamente simili a
    <code>0013444</code>.</p>
    <p>Magari vorrei fermarmi ad una “distanza 3”. Posso interpretare le
    pellicole come nodi, un arco e’ presente se c’e’ una relazione di
    somiglianza tra le due pellicole.</p>
    <h3 id="esempio-base-di-query-ricorsiva"><a
    href="#esempio-base-di-query-ricorsiva">Esempio base di query
    ricorsiva</a></h3>
    <div class="sourceCode" id="cb11"><pre
    class="sourceCode sql"><code class="sourceCode sql"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> RECURSIVE t(n) <span class="kw">AS</span> (</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> <span class="dv">1</span> </span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">UNION</span> <span class="kw">all</span> </span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> n<span class="op">+</span><span class="dv">1</span> <span class="kw">FROM</span> t)</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> n <span class="kw">FROM</span> t</span></code></pre></div>
    <p><code>t(n)</code> specifica che <code>n</code> e’ il nome di cosa
    la query restituisce. <code>SELECT 1</code> e’ il passo base,
    <code>SELECT n+1 FROM t</code> e’ il passo ricorsivo.</p>
    <p>Tutte le query ricorsive quindi seguono questo schema, con la
    <code>UNION</code> tra i due passi.</p>
    <p><code>UNION ALL</code> rimuove duplicati, <code>UNION</code> li
    tiene.</p>
    <p>Il problema di questa query e’ che non si ferma mai, quindi ne
    limitiamo l’esecuzione con la <code>WHERE</code>.</p>
    <div class="sourceCode" id="cb12"><pre
    class="sourceCode sql"><code class="sourceCode sql"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> RECURSIVE t(n) <span class="kw">AS</span> (</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> <span class="dv">1</span> </span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">UNION</span> <span class="kw">all</span> </span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> n<span class="op">+</span><span class="dv">1</span> <span class="kw">FROM</span> t <span class="kw">WHERE</span> n <span class="op">&lt;</span> <span class="dv">10</span>)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> n <span class="kw">FROM</span> t</span></code></pre></div>
    <p>La differenza tra <code>UNION</code> e <code>UNION ALL</code> e’
    nella gestione dei duplicati, la seconda gestisce anche i
    duplicati.</p>
    <h3 id="altro-esempio"><a href="#altro-esempio">Altro
    esempio</a></h3>
    <p>Supponiamo di essere interessati ad una organizzazione dei generi
    che sia gerarchica.</p>
    <div class="sourceCode" id="cb13"><pre
    class="sourceCode sql"><code class="sourceCode sql"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> genre_taxonomy {</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  genre_name <span class="dt">VARCHAR</span> <span class="kw">PRIMARY</span> <span class="kw">KEY</span>,</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  genre_parent <span class="dt">VARCHAR</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> genre_taxonomy </span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="kw">ADD</span> <span class="kw">CONSTRAINT</span> parent_fk <span class="kw">FOREIGN</span> <span class="kw">KEY</span> (genre_parent)</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="kw">REFERENCES</span> genre_taxonomy(genre_name)</span></code></pre></div>
    <p>Serve <code>ALTER TABLE</code> perché e’ un riferimento alla
    tabella stessa, quindi va prima creata la tabella, e poi si può
    introdurre la foreign key.</p>
    <p>Relazione 1 a N:</p>
    <ul>
    <li>1 perché preso un sotto-genere ha sempre e solo 1 padre</li>
    <li>N perché preso un sopra-genere può avere N figli</li>
    </ul>
    <pre><code>- thriller
    - noir
        - poliziesco
            - spionaggio
            - cronaca nera
    - splatter</code></pre>
    <p>Restituire i generi di ‘poliziesco’</p>
    <div class="sourceCode" id="cb15"><pre
    class="sourceCode sql"><code class="sourceCode sql"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> RECURSIVE search_parent(the_genre, parent_genre) <span class="kw">AS</span> (</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> genre_name, genre_parent</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> genre_taxonomy</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">WHERE</span> genre_name <span class="op">=</span> <span class="st">&#39;poliziesco&#39;</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">union</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> sp.the_genre, gt.genre_parent <span class="co">-- nota gli stessi nomi dei parametri</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> search_parent sp </span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">JOIN</span> genre_taxonomy gt <span class="kw">ON</span> sp.genre_parent <span class="op">=</span> gt.genre_name</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> search_parent</span></code></pre></div>
    <p>Si ferma grazie al <code>JOIN</code> che non produce una riga
    quando trova un <code>NULL</code> nella sua condizione di
    <code>ON</code>.</p>
    <p>Restituire i primi due generi di ‘poliziesco’, quindi mi fermo
    “prima di arrivare in cima”</p>
    <p>Aggiungo un parametro <code>distance</code></p>
    <div class="sourceCode" id="cb16"><pre
    class="sourceCode sql"><code class="sourceCode sql"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> RECURSIVE search_parent(the_genre, parent_genre, distance) <span class="kw">AS</span> (</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> genre_name, genre_parent, <span class="dv">1</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> genre_taxonomy</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">WHERE</span> genre_name <span class="op">=</span> <span class="st">&#39;poliziesco&#39;</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">union</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> sp.the_genre, gt.genre_parent, sp.distance <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> search_parent sp </span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">JOIN</span> genre_taxonomy gt <span class="kw">ON</span> sp.genre_parent <span class="op">=</span> gt.genre_name</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">WHERE</span> distance <span class="op">&lt;</span> <span class="dv">1</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> search_parent</span></code></pre></div>
    <h3 id="riprendendo-sulle-pellicole-simili"><a
    href="#riprendendo-sulle-pellicole-simili">Riprendendo sulle
    pellicole simili</a></h3>
    <div class="sourceCode" id="cb17"><pre
    class="sourceCode sql"><code class="sourceCode sql"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> RECURSIVE search_sim(movie, t_movie, distance) <span class="kw">AS</span>(</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> movie1, movie2, <span class="dv">1</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> sim</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">WHERE</span> movie1 <span class="op">=</span> <span class="st">&#39;0013444&#39;</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">UNION</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> ss.movie, si.movie2, distance <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> search_sim ss </span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">JOIN</span> sim si <span class="kw">ON</span> ss.s_movie <span class="op">=</span> si.movie1</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">WHERE</span> distance <span class="op">&lt;</span> <span class="dv">3</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
    <hr />
    <h2 id="esercizi"><a href="#esercizi">Esercizi</a></h2>
    <figure>
    <img src="attachments/imdb-schema.png" alt="IMDB Schema" />
    <figcaption aria-hidden="true">IMDB Schema</figcaption>
    </figure>
    <ul>
    <li>Selezionare il titolo delle pellicole del 2010</li>
    </ul>
    <div class="sourceCode" id="cb18"><pre
    class="sourceCode sql"><code class="sourceCode sql"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> official_title</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> imdb.movie </span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> <span class="dt">year</span> <span class="op">=</span> <span class="st">&#39;2010&#39;</span>;</span></code></pre></div>
    <ul>
    <li>Cercare pellicole che hanno “murder” nel titolo</li>
    </ul>
    <div class="sourceCode" id="cb19"><pre
    class="sourceCode sql"><code class="sourceCode sql"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> imdb.movie</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> official_title <span class="kw">LIKE</span> <span class="st">&#39;%murder%&#39;</span></span></code></pre></div>
    <ul>
    <li>Trovare le pellicole prodotte in due paesi diversi</li>
    </ul>
    <div class="sourceCode" id="cb20"><pre
    class="sourceCode sql"><code class="sourceCode sql"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> imdb.produced p1, imdg.produced p2</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> p1.movie <span class="op">=</span> p2.movie <span class="kw">AND</span> p1.country <span class="op">&lt;&gt;</span> p2.country</span></code></pre></div>
    <p>Pero’ in questo caso ottengo duplicati, quindi dovrei rimuoverli,
    posso risolvere usando il <code>&lt;</code></p>
    <div class="sourceCode" id="cb21"><pre
    class="sourceCode sql"><code class="sourceCode sql"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> p1.movie, p1.country <span class="kw">as</span> country1, p2.country <span class="kw">as</span> country2</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> imdb.produced p1, imdg.produced p2</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> p1.movie <span class="op">=</span> p2.movie <span class="kw">AND</span> p1.country <span class="op">&lt;</span> p2.country</span></code></pre></div>
    <ul>
    <li>Persone decedute in un paese diverso da quello di nascita</li>
    </ul>
    <div class="sourceCode" id="cb22"><pre
    class="sourceCode sql"><code class="sourceCode sql"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> location l1, location l2</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> l1.person <span class="op">=</span> l2.person <span class="kw">AND</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    l1.d_role <span class="op">&lt;&gt;</span> l2.d_role <span class="kw">AND</span> l1.country <span class="op">&lt;&gt;</span> l2.country</span></code></pre></div>
    <p>Ma se la lascio cosi ha duplicati, per rimuoverli uso</p>
    <div class="sourceCode" id="cb23"><pre
    class="sourceCode sql"><code class="sourceCode sql"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> location l1, location l2</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> l1.person <span class="op">=</span> l2.person <span class="kw">AND</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    l1.d_role <span class="op">=</span> <span class="st">&#39;B&#39;</span> <span class="kw">AND</span> l2.d_role <span class="op">=</span> <span class="st">&#39;D&#39;</span> <span class="kw">AND</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    l1.country <span class="op">&lt;&gt;</span> l2.country</span></code></pre></div>
    <ul>
    <li>Trovare le pellicole che non hanno materiali</li>
    </ul>
    <div class="sourceCode" id="cb24"><pre
    class="sourceCode sql"><code class="sourceCode sql"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> movie.<span class="kw">id</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> movie</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="kw">EXCEPT</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">DISTINCT</span> material.movie</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> material</span></code></pre></div>
    <ul>
    <li>Trovare le pellicole che sono prodotte in ITA e USA</li>
    </ul>
    <p>La seguente e’ sbagliata! Scorre la tabella produced cercando un
    record che contemporaneamente abbia country <code>'ITA'</code> e
    <code>'USA'</code></p>
    <div class="sourceCode" id="cb25"><pre
    class="sourceCode sql"><code class="sourceCode sql"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> produced </span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> country <span class="op">=</span> <span class="st">&#39;ITA&#39;</span> <span class="kw">AND</span> country <span class="op">=</span> <span class="st">&#39;USA&#39;</span></span></code></pre></div>
    <p>Viene semplicissimo con l’intersezione occhio a non usare
    <code>*</code> perché in un caso filtriamo country con
    <code>ITA</code> e nell’altro con <code>USA</code> quindi saranno
    sempre diversi, quindi mai intersecabili</p>
    <div class="sourceCode" id="cb26"><pre
    class="sourceCode sql"><code class="sourceCode sql"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> movie <span class="kw">FROM</span> produced <span class="kw">WHERE</span> country <span class="op">=</span> <span class="st">&#39;ITA&#39;</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="kw">INTERSECT</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> movie <span class="kw">FROM</span> produced <span class="kw">WHERE</span> country <span class="op">=</span> <span class="st">&#39;USA&#39;</span></span></code></pre></div>
    <ul>
    <li>Trovare i titoli delle pellicole prodotte in ITA e USA</li>
    </ul>
    <div class="sourceCode" id="cb27"><pre
    class="sourceCode sql"><code class="sourceCode sql"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>, official_title</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> produced <span class="kw">JOIN</span> movie <span class="kw">ON</span> movie <span class="op">=</span> <span class="kw">id</span> </span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> country <span class="op">=</span> <span class="st">&#39;ITA&#39;</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="kw">INTERSECT</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>, official_title</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> produced <span class="kw">JOIN</span> movie <span class="kw">ON</span> movie <span class="op">=</span> <span class="kw">id</span> </span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> country <span class="op">=</span> <span class="st">&#39;USA&#39;</span></span></code></pre></div>
    <p>Metto anche <code>id</code> nella <code>SELECT</code> per avere
    una intersezione solo quando anche l’<code>id</code> (che e’ chiave)
    e’ uguale, altrimenti potrei avere duplicati.</p>
    <p>Posso farlo anche con una CTE
    <label class="sidenote-toggle sidenote-number"></label>. <span
    class="sidenote">Common Table Expressions</span></p>
    <div class="sourceCode" id="cb28"><pre
    class="sourceCode sql"><code class="sourceCode sql"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> mp <span class="kw">AS</span> (</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> produced <span class="kw">INNER</span> <span class="kw">JOIN</span> movie <span class="kw">ON</span> movie <span class="op">=</span> <span class="kw">id</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>, official_title <span class="kw">FROM</span> mp <span class="kw">WHERE</span> country <span class="op">=</span> <span class="st">&#39;ITA&#39;</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="kw">INTERSECT</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>, official_title <span class="kw">FROM</span> mp <span class="kw">WHERE</span> country <span class="op">=</span> <span class="st">&#39;USA&#39;</span></span></code></pre></div>
    <p>Il beneficio e’ creare un oggetto in memoria, temporaneo. Utile
    quando ho bisogno di diversi componenti.</p>
    <p>Oppure ancora</p>
    <div class="sourceCode" id="cb29"><pre
    class="sourceCode sql"><code class="sourceCode sql"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>, official_title <span class="kw">FROM</span> movie <span class="kw">WHERE</span>  <span class="kw">id</span> <span class="kw">IN</span> (</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> movie <span class="kw">FROM</span> produced <span class="kw">WHERE</span> country <span class="op">=</span> <span class="st">&#39;ITA&#39;</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">INTERSECT</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> movie <span class="kw">FROM</span> produced <span class="kw">WHERE</span> country <span class="op">=</span> <span class="st">&#39;USA&#39;</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
    <p>Oppure ancora con self join (che e’ anche un razzo)</p>
    <div class="sourceCode" id="cb30"><pre
    class="sourceCode sql"><code class="sourceCode sql"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> usa.movie</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> produced usa </span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="kw">JOIN</span> produced ita <span class="kw">ON</span> usa.movie <span class="op">=</span> ita.movie</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="kw">JOIN</span> movie <span class="kw">ON</span> usa.movie <span class="op">=</span> <span class="kw">id</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> usa.country <span class="op">=</span> <span class="st">&#39;USA&#39;</span> <span class="kw">AND</span> ita.country <span class="op">=</span> <span class="st">&#39;ITA&#39;</span></span></code></pre></div>
    <ul>
    <li>Trovare titolo dei film con durata superiore alla durata di
    inception</li>
    </ul>
    <p>La seguente non va bene senza <code>ANY</code> perché potrei
    avere più risultati dalla inner query</p>
    <div class="sourceCode" id="cb31"><pre
    class="sourceCode sql"><code class="sourceCode sql"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>, official_title, <span class="fu">length</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> imdb.movie</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> <span class="fu">length</span> <span class="op">&gt;</span> <span class="kw">ANY</span> (</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> <span class="fu">LENGTH</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> imdb.movie</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">WHERE</span> official_title <span class="op">=</span> <span class="st">&#39;Inception&#39;</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
    <p>O anche</p>
    <div class="sourceCode" id="cb32"><pre
    class="sourceCode sql"><code class="sourceCode sql"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">DISTINCT</span> m1.<span class="kw">id</span>, m1.official_title</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> movie m1 <span class="kw">JOIN</span> movie m2</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="kw">ON</span> m1.<span class="fu">length</span> <span class="op">&gt;</span> m2.<span class="fu">length</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> m2.official_title <span class="op">=</span> <span class="st">&#39;Inception&#39;</span></span></code></pre></div>
    <p>TODO e’ possibile usare SELF JOIN per emulare il comportamento
    della ALL?</p>
    <ul>
    <li>Trovare le pellicole prodotte solo in Italia</li>
    </ul>
    <div class="sourceCode" id="cb33"><pre
    class="sourceCode sql"><code class="sourceCode sql"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> p.movie</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> produced p</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> p.country <span class="op">=</span> <span class="st">&#39;ITA&#39;</span> <span class="kw">AND</span> movie <span class="kw">NOT</span> <span class="kw">IN</span> (</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> movie</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> produced</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">WHERE</span> country <span class="op">&lt;&gt;</span> <span class="st">&#39;ITA&#39;</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
    <p>Oppure con la sottrazione</p>
    <div class="sourceCode" id="cb34"><pre
    class="sourceCode sql"><code class="sourceCode sql"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> movie <span class="kw">FROM</span> produced <span class="kw">WHERE</span> country <span class="op">=</span> <span class="st">&#39;ITA&#39;</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="kw">EXCEPT</span> </span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> movie <span class="kw">FROM</span> produced <span class="kw">WHERE</span> country <span class="op">&lt;&gt;</span> <span class="st">&#39;ITA&#39;</span></span></code></pre></div>
    <p>Oppure con join esterno</p>
    <div class="sourceCode" id="cb35"><pre
    class="sourceCode sql"><code class="sourceCode sql"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> itamovies <span class="kw">AS</span> (</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> p.movie</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> produced p</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">WHERE</span> p.country <span class="op">=</span> <span class="st">&#39;ITA&#39;</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>),</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>nonitamovies <span class="kw">AS</span> (</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> movie </span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> produced</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">WHERE</span> country <span class="op">&lt;&gt;</span> <span class="st">&#39;ITA&#39;</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> itamovies <span class="kw">LEFT</span> <span class="kw">JOIN</span> nonitamovies <span class="kw">ON</span> itamovies.movie <span class="op">=</span> nonitamovies.movie</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> nonitamovies.movie <span class="kw">IS</span> <span class="kw">NULL</span></span></code></pre></div>
    <p>Oppure senza <code>WITH</code></p>
    <div class="sourceCode" id="cb36"><pre
    class="sourceCode sql"><code class="sourceCode sql"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">DISTINCT</span> itamovies.<span class="op">*</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> produced itamovies</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="kw">LEFT</span> <span class="kw">JOIN</span> produced nonitamovies <span class="kw">ON</span> itamovies.movie <span class="op">=</span> nonitamovies.movie <span class="kw">AND</span> nonitamovies.country <span class="op">&lt;&gt;</span> <span class="st">&#39;ITA&#39;</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> itamovies.country <span class="op">=</span> <span class="st">&#39;ITA&#39;</span> <span class="kw">AND</span> nonitamovies.movie <span class="kw">IS</span> <span class="kw">NULL</span></span></code></pre></div>
    <ul>
    <li>Trovare il titolo di tutti i film con relativi generi</li>
    </ul>
    <p>La seguente non troverebbe i film che non hanno genere</p>
    <div class="sourceCode" id="cb37"><pre
    class="sourceCode sql"><code class="sourceCode sql"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>, official_title, genre</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> movie </span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="kw">JOIN</span> genre <span class="kw">ON</span> movie.<span class="kw">id</span> <span class="op">=</span> genre.movie</span></code></pre></div>
    <p>quindi</p>
    <div class="sourceCode" id="cb38"><pre
    class="sourceCode sql"><code class="sourceCode sql"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>, official_title, genre</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> movie</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="kw">LEFT</span> <span class="kw">JOIN</span> genre <span class="kw">ON</span> movie.<span class="kw">id</span> <span class="op">=</span> genre.movie</span></code></pre></div>
    <ul>
    <li>Per ogni persona mostrare il nome e il country dove e’ deceduto,
    incluse le persone per le quali non abbiamo un country di
    decesso</li>
    </ul>
    <div class="sourceCode" id="cb39"><pre
    class="sourceCode sql"><code class="sourceCode sql"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>, given_name, country</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> person </span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="kw">LEFT</span> <span class="kw">JOIN</span> location <span class="kw">ON</span> person.<span class="kw">id</span> <span class="op">=</span> location.person</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> d_role <span class="op">=</span> <span class="st">&#39;D&#39;</span></span></code></pre></div>
    <p>La <code>WHERE</code> viene valutata sull’effetto del
    <code>JOIN</code>, quindi lo annulla, perché per i record spuri
    <code>d_role</code> sarebbe <code>NULL</code>, quindi la query non
    e’ corretta perché non aggiunge i <code>NULL</code>.</p>
    <p>Possibile soluzione in cui filtriamo prima</p>
    <div class="sourceCode" id="cb40"><pre
    class="sourceCode sql"><code class="sourceCode sql"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> deaths <span class="kw">AS</span> (</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> <span class="op">*</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> location l</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">WHERE</span> d_role <span class="op">=</span> <span class="st">&#39;D&#39;</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>, given_name, country</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> person </span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a><span class="kw">LEFT</span> <span class="kw">JOIN</span> deaths <span class="kw">ON</span> person.<span class="kw">id</span> <span class="op">=</span> deaths.person</span></code></pre></div>
    <p>Oppure imponiamo il filtro nel momento del join</p>
    <div class="sourceCode" id="cb41"><pre
    class="sourceCode sql"><code class="sourceCode sql"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>, given_name, country</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> person </span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="kw">LEFT</span> <span class="kw">JOIN</span> location <span class="kw">ON</span> person.<span class="kw">id</span> <span class="op">=</span> location.person <span class="kw">AND</span> d_role <span class="op">=</span> <span class="st">&#39;D&#39;</span></span></code></pre></div>
    <ul>
    <li>Trovare coppie di pellicole che non hanno generi in comune</li>
    </ul>
    <p>“Da tutte le possibili combinazioni, togliamo le pellicole che
    hanno un genere in comune”</p>
    <div class="sourceCode" id="cb42"><pre
    class="sourceCode sql"><code class="sourceCode sql"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">DISTINCT</span> g1.movie, g2.movie</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> genre g1 <span class="kw">JOIN</span> genre g2 <span class="kw">ON</span> g1.movie <span class="op">&gt;</span> g2.movie</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a><span class="kw">except</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">DISTINCT</span> g1.movie, g2.movie</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> genre g1 <span class="kw">JOIN</span> genre g2 <span class="kw">ON</span> g1.movie <span class="op">&gt;</span> g2.movie</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> g1.genre <span class="op">=</span> g2.genre</span></code></pre></div>
    <p>oppure (notare l’uso di <code>c</code> nella <a
    href="SQL.md#Query%20correlata">Query correlata</a>)</p>
    <div class="sourceCode" id="cb43"><pre
    class="sourceCode sql"><code class="sourceCode sql"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> couples <span class="kw">as</span> (</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> <span class="kw">DISTINCT</span> g1.movie <span class="kw">AS</span> movie1, g2.movie <span class="kw">AS</span> movie2</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> genre g1 <span class="kw">JOIN</span> genre g2 <span class="kw">ON</span> g1.movie <span class="op">&gt;</span> g2.movie</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> </span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> couples c</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> <span class="kw">NOT</span> <span class="kw">EXISTS</span> (</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> <span class="op">*</span> ;; irrilevante cosa abbiamo qui</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> genre g1, genre g2</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">WHERE</span> g1.movie <span class="op">=</span> c.movie1 <span class="kw">AND</span> g1.movie <span class="op">=</span> c.movie2 <span class="kw">AND</span> g1.genre <span class="op">=</span> g2.genre</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
    <ul>
    <li>Trovare i film che non sono stati distribuiti nei paesi nei
    quali sono stati prodotti</li>
    </ul>
    <p>Tabelle interessate: produced e released</p>
    <p>Un movie <code>m</code> viene inserito nel risultato se non
    esiste un record della tabella produced <code>p</code> per il quale
    esiste un record di release relativo allo stesso movie e paese di
    <code>p</code></p>
    <div class="sourceCode" id="cb44"><pre
    class="sourceCode sql"><code class="sourceCode sql"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>, official_title</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> movie m</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> <span class="kw">NOT</span> <span class="kw">EXISTS</span> (</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> <span class="op">*</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> produced p</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">WHERE</span> p.movie <span class="op">=</span> m.<span class="kw">id</span> <span class="kw">AND</span> <span class="kw">EXISTS</span> (</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">SELECT</span> <span class="op">*</span></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">FROM</span> released r</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">WHERE</span> r.movie <span class="op">=</span> m.<span class="kw">id</span> <span class="kw">AND</span> p.country <span class="op">=</span> r.country</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
    <p>Utile quando devo contemporaneamente far valere più vincoli. Con
    gli operatori insiemistici non me la cavo perché devo controllare le
    condizioni su ogni singolo record. TODO ESPANDERE Con esempio e
    spiegazione</p>
    <p>Oppure</p>
    <div class="sourceCode" id="cb45"><pre
    class="sourceCode sql"><code class="sourceCode sql"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>, official_title</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> movie m</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> <span class="kw">NOT</span> <span class="kw">EXISTS</span> (</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> <span class="op">*</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> produced p <span class="kw">JOIN</span> released r <span class="kw">ON</span> p.movie <span class="op">=</span> r.movie <span class="kw">AND</span> </span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>        p.country <span class="op">=</span> r.country</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">WHERE</span> p.movie <span class="op">=</span> m.<span class="kw">id</span></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
    <ul>
    <li>Trovare il film di durata maggiore</li>
    </ul>
    <div class="sourceCode" id="cb46"><pre
    class="sourceCode sql"><code class="sourceCode sql"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="fu">max</span>(<span class="fu">length</span>)</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> movie</span></code></pre></div>
    <ul>
    <li>Trovare il film di durata maggiore e restituire il titolo</li>
    </ul>
    <p>La seguente va in errore perché nell’aggregare perdono il
    riferimento alla tupla che contiene quel valore, inoltre potrei
    avere più di un record con quel valore, quindi devo aggregare tutto
    ciò che voglio selezionare</p>
    <div class="sourceCode" id="cb47"><pre
    class="sourceCode sql"><code class="sourceCode sql"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>, official_title, <span class="fu">max</span>(<span class="fu">length</span>) <span class="kw">FROM</span> movie</span></code></pre></div>
    <p>Un modo per farlo e’</p>
    <div class="sourceCode" id="cb48"><pre
    class="sourceCode sql"><code class="sourceCode sql"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> movie <span class="kw">WHERE</span> <span class="fu">length</span> <span class="op">=</span> (</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> <span class="fu">MAX</span>(<span class="fu">length</span>) <span class="kw">as</span> durata_massima <span class="kw">FROM</span> movie</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
    <p>Oppure anche</p>
    <div class="sourceCode" id="cb49"><pre
    class="sourceCode sql"><code class="sourceCode sql"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> mmax <span class="kw">AS</span> (</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> <span class="fu">MAX</span>(<span class="fu">length</span>) <span class="kw">as</span> durata_massima <span class="kw">FROM</span> movie</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> m.<span class="op">*</span> </span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> movie <span class="kw">JOIN</span> mmax <span class="kw">ON</span> m.<span class="fu">length</span> <span class="op">=</span> mmax.durata_massima</span></code></pre></div>
    <ul>
    <li>Trovare il numero di pellicole per le quali e’ noto l’anno di
    produzione</li>
    </ul>
    <p>Non serve specificare <code>WHERE year IS NOT NULL</code> (vedi
    descrizione <code>COUNT</code>)</p>
    <div class="sourceCode" id="cb50"><pre
    class="sourceCode sql"><code class="sourceCode sql"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="fu">count</span>(<span class="dt">year</span>) <span class="kw">FROM</span> movie</span></code></pre></div>
    <p>Invece cosi serve</p>
    <div class="sourceCode" id="cb51"><pre
    class="sourceCode sql"><code class="sourceCode sql"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">FROM</span> MOVIE <span class="kw">WHERE</span> <span class="dt">year</span> <span class="kw">IS</span> <span class="kw">NOT</span> <span class="kw">NULL</span></span></code></pre></div>
    <ul>
    <li>Trovare il numero di titoli diversi delle pellicole</li>
    </ul>
    <div class="sourceCode" id="cb52"><pre
    class="sourceCode sql"><code class="sourceCode sql"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="fu">COUNT</span>(<span class="kw">DISTINCT</span> official_title) <span class="kw">FROM</span> movie</span></code></pre></div>
    <ul>
    <li>Trovare la durata media dei film del 2010</li>
    </ul>
    <div class="sourceCode" id="cb53"><pre
    class="sourceCode sql"><code class="sourceCode sql"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="fu">sum</span>(<span class="fu">length</span>) <span class="op">/</span> <span class="fu">count</span>(<span class="fu">length</span>)</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> movie</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> <span class="dt">year</span> <span class="op">=</span> <span class="st">&#39;2010&#39;</span></span></code></pre></div>
    <ul>
    <li>Trovare il numero di pellicole per ogni anno disponibile</li>
    </ul>
    <p>Conteggia in base ad ogni gruppo trovato dalla
    <code>GROUP BY</code></p>
    <div class="sourceCode" id="cb54"><pre
    class="sourceCode sql"><code class="sourceCode sql"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="dt">year</span>, <span class="fu">COUNT</span>(<span class="op">*</span>)</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> movie</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> <span class="dt">year</span></span></code></pre></div>
    <ul>
    <li>Trovare per ciascun film il numero di persone coinvolte per
    ciascun ruolo</li>
    </ul>
    <div class="sourceCode" id="cb55"><pre
    class="sourceCode sql"><code class="sourceCode sql"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="fu">COUNT</span>(<span class="op">*</span>)</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> crew</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> movie, c.p_role</span></code></pre></div>
    <ul>
    <li>Trovare il numero di valutazioni per ogni film</li>
    </ul>
    <p>La seguente pero’ non tiene conto delle pellicole senza
    valutazioni, perché dentro <code>rating</code> ho solo pellicole già
    valutate</p>
    <div class="sourceCode" id="cb56"><pre
    class="sourceCode sql"><code class="sourceCode sql"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> movie, <span class="fu">COUNT</span>(<span class="op">*</span>) </span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> rating</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> movie</span></code></pre></div>
    <p>La seguente produce il risultato atteso ma e’ convoluta</p>
    <div class="sourceCode" id="cb57"><pre
    class="sourceCode sql"><code class="sourceCode sql"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> movie, <span class="fu">COUNT</span>(<span class="op">*</span>)</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> ratingGROUP <span class="kw">BY</span> movie</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a><span class="kw">UNION</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> <span class="kw">id</span>, <span class="dv">0</span></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> movie</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">EXCEPT</span> </span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> movie, <span class="dv">0</span></span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> rating</span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
    <p>Nella seguente occhio a non usare <code>COUNT(*)</code> perché
    altrimenti conterebbe le righe, invece usando
    <code>COUNT(r.movie)</code> conteggio quando la riga non e’
    spuria.</p>
    <div class="sourceCode" id="cb58"><pre
    class="sourceCode sql"><code class="sourceCode sql"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> movie, <span class="fu">COUNT</span>(r.movie)</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> movie m <span class="kw">LEFT</span> <span class="kw">JOIN</span> rating r <span class="kw">ON</span> m.<span class="kw">id</span> <span class="op">=</span> r.movie</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> <span class="kw">id</span></span></code></pre></div>
    <ul>
    <li>Trovare il miglior rating di ciascun film</li>
    </ul>
    <div class="sourceCode" id="cb59"><pre
    class="sourceCode sql"><code class="sourceCode sql"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> movie, <span class="fu">MAX</span>(score <span class="op">/</span> scale)</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> movie m <span class="kw">LEFT</span> <span class="kw">JOIN</span> rating r <span class="kw">on</span> movie.<span class="kw">id</span> <span class="op">=</span> rating.movie</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> <span class="kw">id</span></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> <span class="dv">2</span> <span class="kw">DESC</span></span></code></pre></div>
    <ul>
    <li>Trovare l’attore che ha recitato nel maggior numero di film</li>
    </ul>
    <p><code>MAX(COUNT(*))</code> non si può fare.</p>
    <p>La seguente e’ sbagliata, perché potrebbero esserci più record
    con il valore massimo. <code>DISTINCT MOVIE</code> per rimuovere
    attori con più di un ruolo nello stesso film.</p>
    <div class="sourceCode" id="cb60"><pre
    class="sourceCode sql"><code class="sourceCode sql"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> person, <span class="fu">COUNT</span>(<span class="kw">DISTINCT</span> movie)</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> crew</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> p_role <span class="op">=</span> <span class="st">&#39;actor&#39;</span></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> person</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> <span class="dv">2</span> <span class="kw">DESC</span></span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a><span class="kw">LIMIT</span> <span class="dv">1</span></span></code></pre></div>
    <p>Soluzione</p>
    <div class="sourceCode" id="cb61"><pre
    class="sourceCode sql"><code class="sourceCode sql"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> recitazioni <span class="kw">AS</span> (</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> person, <span class="fu">COUNT</span>(<span class="kw">DISTINCT</span> movie) <span class="kw">AS</span> n_partecipazioni</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> crew</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">WHERE</span> p_role <span class="op">=</span> <span class="st">&#39;actor&#39;</span></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">GROUP</span> <span class="kw">BY</span> person</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>, given_name, n_partecipazioni</span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> person p <span class="kw">JOIN</span> recitazioni r <span class="kw">ON</span> p.<span class="kw">id</span> <span class="op">=</span> r.person</span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> n_partecipazioni <span class="op">=</span> (</span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> <span class="fu">MAX</span>(n_partecipazioni) <span class="kw">AS</span> max_partecipazioni</span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> recitazioni)</span></code></pre></div>
    <p>Soluzione alternativa</p>
    <div class="sourceCode" id="cb62"><pre
    class="sourceCode sql"><code class="sourceCode sql"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> person, <span class="fu">COUNT</span>(<span class="kw">DISTINCT</span> movie) <span class="kw">AS</span> n_partecipazioni</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> crew</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> p_role <span class="op">=</span> <span class="st">&#39;actor&#39;</span></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> person</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a><span class="kw">HAVING</span> <span class="fu">COUNT</span>(<span class="kw">DISTINCT</span> movie) <span class="op">&gt;=</span> <span class="kw">ALL</span> (</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> <span class="fu">COUNT</span>(<span class="kw">DISTINCT</span> movie)</span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> crew</span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">WHERE</span> p_role <span class="op">=</span> <span class="st">&#39;actor&#39;</span></span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">GROUP</span> <span class="kw">BY</span> person</span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
    <ul>
    <li>Trovare i film con cast più numeroso della media dei film del
    medesimo genere</li>
    </ul>
    <div class="sourceCode" id="cb63"><pre
    class="sourceCode sql"><code class="sourceCode sql"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> movie_cast <span class="kw">AS</span> (</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> movie, <span class="fu">COUNT</span>(<span class="kw">DISTINCT</span> person) <span class="kw">AS</span> n_person</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> crew</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">WHERE</span> p_role <span class="kw">in</span> (<span class="st">&#39;actor&#39;</span>, <span class="st">&#39;director&#39;</span>)</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">GROUP</span> <span class="kw">BY</span> movie</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>),</span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>avg_genre <span class="kw">AS</span> (</span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> genre, <span class="fu">AVG</span>(n_person) <span class="kw">as</span> avg_cast</span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> movie m <span class="kw">LEFT</span> </span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">LEFT</span> <span class="kw">JOIN</span> genre g <span class="kw">ON</span> m.<span class="kw">id</span> <span class="op">=</span> g.movie </span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">LEFT</span> <span class="kw">JOIN</span> movie_cast mc <span class="kw">ON</span> m.<span class="kw">id</span> <span class="op">=</span> mc.movie</span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">GROUP</span> <span class="kw">BY</span> genre</span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb63-14"><a href="#cb63-14" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> m.<span class="kw">id</span>, official_title, g.genre, n_person</span>
<span id="cb63-15"><a href="#cb63-15" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> movie m</span>
<span id="cb63-16"><a href="#cb63-16" aria-hidden="true" tabindex="-1"></a><span class="kw">LEFT</span> <span class="kw">JOIN</span> genre g <span class="kw">ON</span> m.<span class="kw">id</span> <span class="op">=</span> g.movie</span>
<span id="cb63-17"><a href="#cb63-17" aria-hidden="true" tabindex="-1"></a><span class="kw">LEFT</span> <span class="kw">JOIN</span> movie_cast mc <span class="kw">ON</span> m.<span class="kw">id</span> <span class="op">=</span> mc.movie</span>
<span id="cb63-18"><a href="#cb63-18" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> mc.n_person <span class="op">&gt;</span> (</span>
<span id="cb63-19"><a href="#cb63-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> avg_cast </span>
<span id="cb63-20"><a href="#cb63-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> avg_genre </span>
<span id="cb63-21"><a href="#cb63-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">WHERE</span> g.genre <span class="op">=</span> avg_genre.genre </span>
<span id="cb63-22"><a href="#cb63-22" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
    <ul>
    <li>Trovare le persone che hanno recitato in tutti i film di genere
    crime (divisione)</li>
    </ul>
    <p>Tabelle utili <span class="math display">$$
    \begin{align}
    &amp;\ crew(person,\ movie) \newline
    &amp;\ genre(movie,\ genre) \newline
    \end{align}
    $$</span></p>
    <p>In algebra e’ <span class="math display">$$
    \begin{align}
    &amp;\ A = \pi_{(person,movie)} crew \newline
    &amp;\ B = \pi_{movie}(\sigma_{genre='Crime}) \newline
    &amp;\ A / B \newline
    \end{align}
    $$</span></p>
    <div class="sourceCode" id="cb64"><pre
    class="sourceCode sql"><code class="sourceCode sql"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>, given_name</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> person p</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> <span class="kw">NOT</span> <span class="kw">EXISTS</span> (</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> <span class="op">*</span></span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> genre g</span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">WHERE</span> g.genre <span class="op">=</span> <span class="st">&#39;Crime&#39;</span> <span class="kw">AND</span> <span class="kw">NOT</span> <span class="kw">EXISTS</span> (</span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">SELECT</span> <span class="op">*</span></span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">FROM</span> crew c</span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">WHERE</span> p_role <span class="op">=</span> <span class="st">&#39;actor&#39;</span> <span class="kw">AND</span> p.<span class="kw">id</span> <span class="op">=</span> c.person <span class="kw">AND</span> g.movie <span class="op">=</span> crew.movie</span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
    <ul>
    <li>Restituire le persone che hanno svolto più di un ruolo
    all’interno dello stesso team</li>
    </ul>
    <p>Questa prima query e’ in grado di dire quali ruoli e la persona
    ha svolto e in che film…</p>
    <div class="sourceCode" id="cb65"><pre
    class="sourceCode sql"><code class="sourceCode sql"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">DISTINCT</span> c1.person, c1.p_role, c2.p_role, c1.movie</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> crew c1</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a><span class="kw">JOIN</span> crew c2 <span class="kw">ON</span> c1.person <span class="op">=</span> c2.person</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> c1.p_role <span class="op">&lt;&gt;</span> c2.p_role <span class="kw">AND</span> c1.movie <span class="op">=</span> c2.movie</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> c1.person</span></code></pre></div>
    <p>…mentre questa query e’ in grado di dire che la data
    <code>person</code> ha svolto più ruoli all’interno del film, ma non
    sa dire quali per via dell’aggregazione che fa perdere informazione;
    per contro questa query e’ più performante della precedente</p>
    <div class="sourceCode" id="cb66"><pre
    class="sourceCode sql"><code class="sourceCode sql"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> person, movie</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> crew</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> movie, person</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a><span class="kw">HAVING</span> <span class="fu">COUNT</span>(<span class="kw">DISTINCT</span> p_role) <span class="op">&gt;</span> <span class="dv">1</span>;</span></code></pre></div>
    <ul>
    <li>Trovare i film che hanno un cast più numeroso della media</li>
    </ul>
    <p><code>ANY</code> e’ opzionale nel caso di un solo record
    ritornato</p>
    <div class="sourceCode" id="cb67"><pre
    class="sourceCode sql"><code class="sourceCode sql"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> cast_crew_num <span class="kw">AS</span> (</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> movie, <span class="fu">COUNT</span>(<span class="op">*</span>)</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> crew</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">GROUP</span> <span class="kw">BY</span> movie</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>),</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>mean <span class="kw">AS</span> (</span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> <span class="fu">AVG</span>(<span class="fu">count</span>) <span class="kw">AS</span> m</span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> cast_crew_num</span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span>, (<span class="kw">SELECT</span> m <span class="kw">FROM</span> mean)</span>
<span id="cb67-12"><a href="#cb67-12" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> cast_crew_num</span>
<span id="cb67-13"><a href="#cb67-13" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> <span class="fu">count</span> <span class="op">&gt;</span> (<span class="kw">SELECT</span> m <span class="kw">FROM</span> mean)</span></code></pre></div>
    </article>
  </main>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <script src="js/prism.min.js"></script>
</body>
